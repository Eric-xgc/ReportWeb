
@using ReportWeb.Models.ALE
@model List<GruppoApprovatoModel>

<div class="col-sm-12">
    <table class="table table-condensed" id="tblGruppi">
        <thead>
            <tr>
                <th width="5%"><label>ID</label></th>
                <th width="10%"><label>Lavorante</label></th>
                <th width="75%"><label>Nota</label></th>
                <th width="5%"></th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (GruppoApprovatoModel a in Model)
            {
                <tr valign="top">
                    <td>@a.IDALEGRUPPO</td>
                    <td>@a.LavoranteDescrizione</td>
                    <td>@a.NotaApprovazione</td>
                    <input type="hidden" value="@a.IDALEGRUPPO" class="hdIDALEGRUPPO" />
                    <td width="10%"><input type="button" onclick="MostraDettaglioGruppoDaFatturare(this,@a.IDALEGRUPPO);" class="btn-primary" value="Dettaglio" /></td>
                    <td>    <input type="button" onclick="FatturaGruppo(this,@a.IDALEGRUPPO);" class="btn-primary" value="Fattura" /></td>
                </tr>
                <tr>
                    <td></td>
                    <td colspan="2">
                        <div id="Dettaglio_@a.IDALEGRUPPO" style="display:none">
                            <table width="100%" class="table">
                                <thead>
                                    <tr>
                                        <th style="font-size:11px">
                                            Modello
                                        </th>
                                        <th style="font-size:11px">
                                            Difetto
                                        </th>
                                        <th style="font-size:11px">
                                            Lavorante
                                        </th>
                                        <th style="font-size:11px">
                                            Qta.Add
                                        </th>
                                        <th style="font-size:11px">
                                            Prezzo
                                        </th>
                                        <th style="font-size:11px">
                                            Valore
                                        </th>
                                        <th style="font-size:11px">
                                            Nota
                                        </th>
                                    </tr>
                                </thead>
                                @foreach (ApprovatoModel dettaglio in a.Dettagli)
                                {
                                    <tr class="RWTRDettaglio">
                                        <input type="hidden" class="hdIdAleDettaglio" value="@dettaglio.IdAleDettaglio" />
                                        <td style="font-size:11px">@string.Format("{0} - {1}", dettaglio.Modello, dettaglio.ModelloDescrizione) </td>
                                        <td style="font-size:11px">@string.Format("{0} - {1}", dettaglio.TipoDifetto, dettaglio.Difetto) </td>
                                        <td style="font-size:11px">@dettaglio.LavoranteDescrizione</td>
                                        <td style="font-size:11px">@dettaglio.QuantitaAddebitata</td>
                                        <td style="font-size:11px">@dettaglio.PrezzoApprovato</td>
                                        <td style="font-size:11px" class="RWValoreAttribuito">@(dettaglio.Prezzo * dettaglio.QuantitaAddebitata)</td>
                                        <td style="font-size:12px">@Html.TextBox("txtNota", "", new { @maxlength = "100", @class = "form-control input-sm RWNota", @style = "height: 21px;" })</td>
                                    </tr>
                                    if (!string.IsNullOrEmpty(dettaglio.Nota))
                                    {
                                        <tr>
                                            <td style="font-size:11px" colspan="6">@string.Format("Nota inserimento: {0}", dettaglio.Nota)</td>
                                        </tr>
                                    }
                                    if (!string.IsNullOrEmpty(dettaglio.NotaAddebito))
                                    {
                                        <tr>
                                            <td style="font-size:11px" colspan="6">@string.Format("Nota addebito: {0}", dettaglio.NotaAddebito)</td>
                                        </tr>
                                    }
                                    if (!string.IsNullOrEmpty(dettaglio.NotaValorizzazione))
                                    {
                                        <tr>
                                            <td style="font-size:11px" colspan="6">@string.Format("Nota valorizzazione: {0}", dettaglio.NotaValorizzazione)</td>
                                        </tr>
                                    }
                                    if (!string.IsNullOrEmpty(dettaglio.NotaApprovazione))
                                    {
                                        <tr>
                                            <td style="font-size:11px" colspan="6">@string.Format("Nota approvazione: {0}", dettaglio.NotaValorizzazione)</td>
                                        </tr>
                                    }
                                }
                                <tr class="RWTotali">
                                    <td><label>Dati fatturazione</label></td>
                                    <td colspan="3">@Html.TextBox("txtNota", "", new { @maxlength = "100", @class = "form-control input-sm RWNotaGruppo", @style = "height: 21px;" })</td>
                                    <td class="text-red">TOTALE</td>
                                    <td class="text-red"><input readonly type="text" id="RWTotaleAtribuito" value="@a.ValoreTotale.ToString()" /></td>
                                </tr>
                            </table>
                        </div>
                    </td>
                    <td></td>
                    <td></td>
                </tr>
            }
        </tbody>
    </table>
</div>


<script language="javascript" type="text/javascript">
    $(function ()
    {
        
    });

    function MostraDettaglioGruppoDaFatturare(sender, IDALEGRUPPO)
    {
        var title = $(sender).attr("value");

        var divName = "#Dettaglio_" + IDALEGRUPPO;

        if (title == "Dettaglio")
        {
            $(divName).show();
            $(sender).attr("value", "Chiudi");
        }

        if (title == "Chiudi")
        {
            $(divName).hide();
            $(sender).attr("value", "Dettaglio");
        }
    }

    function FatturaGruppo(sender, IDALEGRUPPO)
    {
        
        var divGruppoName = "#Dettaglio_" + IDALEGRUPPO;
        var divGruppo = $(divGruppoName);

        var trDettaglio = $(".RWTRDettaglio", divGruppo);
        var dettagli = [];
        var notaGruppo = $(".RWNotaGruppo", divGruppo);

        if (notaGruppo.val() == '')
        {
            $('#lblMessage').html("Inserire i dati di fatturazione");
            return;
        }
        for (var i = 0 ; i < trDettaglio.length; i++)
        {
            var idDettaglio = $(".hdIdAleDettaglio", trDettaglio[i]);
            var idd = $(idDettaglio).val();

            var p = -1;

            var nota = $(".RWNota", trDettaglio[i]);
            var n = $(nota).val();

            var dettaglio = { 'IdAleDettaglio': idd, 'Prezzo': p, 'Nota': n };
            dettagli.push(dettaglio);
        }

        var dettagliJson = JSON.stringify(dettagli);

        var url = '@Url.Action("FatturaGruppo", "ALE")';
        $.ajax({
            url: url,
            data: { IDALEGRUPPO: IDALEGRUPPO, Dettagli: dettagliJson, Nota: notaGruppo.val() },
            cache: false,
            type: "POST",
            success: function (data)
            {
                CaricaGruppiDaFatturare();
                CaricaGruppiFatturati();
            },
            error: function (response)
            {
                document.open();
                document.write(response.responseText);
                document.close();
            }
        });
    }

</script>
